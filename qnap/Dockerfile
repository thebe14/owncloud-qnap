ARG OWNCLOUD_MARIADB_IMAGE_TAG
FROM $OWNCLOUD_MARIADB_IMAGE_TAG

ARG BACKUP_INIT_SLEEP
ARG BACKUP_INTERVAL
ARG OWNCLOUD_HOSTNAME
ARG OWNCLOUD_DB_NAME
ARG OWNCLOUD_DB_USER
ARG OWNCLOUD_DB_PASSWORD
ARG MARIADB_BACKUP_PRUNE_DAYS
ARG DATA_BACKUP_PRUNE_DAYS
ARG MARIADB_BACKUPS_PATH
ARG DATA_BACKUPS_PATH
ARG DATA_PATH
ARG MARIADB_BACKUP_NAME
ARG DATA_BACKUP_NAME
ARG CERTS_PATH

ENV BACKUP_INIT_SLEEP ${BACKUP_INIT_SLEEP}
ENV BACKUP_INTERVAL ${BACKUP_INTERVAL}
ENV OWNCLOUD_HOSTNAME ${OWNCLOUD_HOSTNAME}
ENV OWNCLOUD_DB_NAME ${OWNCLOUD_DB_NAME}
ENV OWNCLOUD_DB_USER ${OWNCLOUD_DB_USER}
ENV OWNCLOUD_DB_PASSWORD "${OWNCLOUD_DB_PASSWORD}"
ENV MARIADB_BACKUP_PRUNE_DAYS ${MARIADB_BACKUP_PRUNE_DAYS}
ENV DATA_BACKUP_PRUNE_DAYS ${DATA_BACKUP_PRUNE_DAYS}
ENV MARIADB_BACKUPS_PATH ${MARIADB_BACKUPS_PATH}
ENV DATA_BACKUPS_PATH ${DATA_BACKUPS_PATH}
ENV DATA_PATH ${DATA_PATH}
ENV MARIADB_BACKUP_NAME ${MARIADB_BACKUP_NAME}
ENV DATA_BACKUP_NAME ${DATA_BACKUP_NAME}
ENV CERTS_PATH ${CERTS_PATH}

# Install jq
RUN apt-get update -y && \
    apt-get install -y jq && \
    apt-get -q clean && \
    rm -rf /var/lib/apt/lists/*

CMD sh -c 'sleep $BACKUP_INIT_SLEEP && \
    while true; do \
      mariadb-dump -h mariadb -u $OWNCLOUD_DB_USER -p"$OWNCLOUD_DB_PASSWORD" $OWNCLOUD_DB_NAME | gzip > "$MARIADB_BACKUPS_PATH/$MARIADB_BACKUP_NAME-$(date '+%Y-%m-%d_%H-%M').gz" && \
      tar -zcpf $DATA_BACKUPS_PATH/$DATA_BACKUP_NAME-$(date "+%Y-%m-%d_%H-%M").tar.gz $DATA_PATH && \
      find $MARIADB_BACKUPS_PATH -type f -mtime +$MARIADB_BACKUP_PRUNE_DAYS | xargs rm -f && \
      find $DATA_BACKUPS_PATH -type f -mtime +$DATA_BACKUP_PRUNE_DAYS | xargs rm -f && \
      jq -r ".letsencrypt.Certificates[] | select(.domain.main==\"$OWNCLOUD_HOSTNAME\") | .certificate" /usr/traefik/acme/acme.json | base64 -d > $CERTS_PATH/cert.pem; \
      jq -r ".letsencrypt.Certificates[] | select(.domain.main==\"$OWNCLOUD_HOSTNAME\") | .key" /usr/traefik/acme/acme.json | base64 -d > $CERTS_PATH/key.pem; \
      sleep $BACKUP_INTERVAL; done'
